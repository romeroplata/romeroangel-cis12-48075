(function(){var n=ol.templateMap=ol.templateMap||{};n["#initialShareSkyDriveTemplate"]={tmpls:[],links:{},tags:{},bnds:[{fn:function(n){return[{tmpl:0,params:'ShareSkyDriveData tmpl="#richTextShareSkyDriveTemplate" ',props:{tmpl:"#richTextShareSkyDriveTemplate"},args:[n.ShareSkyDriveData]}]},paths:["ShareSkyDriveData"],_ctxs:"for"}],_is:"template",allowCode:!0,tmplName:"initialShareSkyDriveTemplate",htmlTag:"table",fn:{fn:function(n,t,i,r){var i=i||jsviews,f,e=i._tag,o=i._cnvt,u="";return u+='    <table style="height:100%;width:100%" class="shareSkyDriveTable">        <tbody>            <tr>                <td style="padding:0">                    <div id="ecx_rte_preskyattach" style="font-size:12pt;font-family:Calibri,sans-serif;outline:none;height:100%;" contentEditable="true"><\/div>                <\/td>            <\/tr>            <tr>                <td ',u+=(f=t.hlp("sutra")("skydrivesection"))!=r?f:"",u+=' class="ShareSkyDriveSection" style="padding:30px 0;-moz-user-select:none">                    <div ',u+=(f=t.hlp("sutra")("skydriveheader"))!=r?f:"",u+=' style="',u+=o("attr",t,{params:"~getHeaderCss()",props:{},args:[t.hlp("getHeaderCss")()]}),u+='" data-link="text{getHeader: TotalFileCount}"><\/div>                    ',u+=e("for",t,this,1),u+'                <\/td>            <\/tr>            <tr style="height:100%">                <td style="height:100%;padding:0">                    <div id="ecx_rte_postskyattach" style="font-size:12pt;font-family:Calibri,sans-serif;outline:none;height:100%;" contentEditable="true"><\/div>                <\/td>            <\/tr>        <\/tbody>    <\/table>'}}},n["#richTextShareSkyDriveTemplate"]={tmpls:[{tmpls:[],links:{},tags:{},bnds:[],_is:"template",allowCode:!0,htmlTag:"span",tmplName:"richTextShareSkyDriveTemplate/for",fn:{fn:function(n,t,i,r){var i=i||jsviews,e,f=i._cnvt,u="";return u+="        <span ",u+=(e=t.hlp("sutra")("skydriveimageitem"))!=r?e:"",u+=' class="shareSkyDriveItem" objectId="',u+=f("attr",t,{params:"id",props:{},args:[n.id]}),u+='" viewLink="',u+=f("attr",t,{params:"viewInBrowserLink",props:{},args:[n.viewInBrowserLink]}),u+='" ext="',u+=f("attr",t,{params:"extension",props:{},args:[n.extension]}),u+='">            <a style="text-decoration:none;font-size:0;" href="',u+=f("attr",t,{params:"permissionsLink",props:{},args:[n.permissionsLink]}),u+='" data-link="href{:permissionsLink}">                <img ',u+=(e=t.hlp("sutra")("skydriveimagetile"))!=r?e:"",u+=' height="104px" width="104px" src="',u+=f("attr",t,{params:"thumbnailUrl",props:{},args:[n.thumbnailUrl]}),u+='" style="',u+=f("attr",t,{params:"~getImageCss()",props:{},args:[t.hlp("getImageCss")()]}),u+'" />            <\/a>        <\/span>        '}}},{tmpls:[],links:{},tags:{},bnds:[],_is:"template",allowCode:!0,htmlTag:"div",tmplName:"richTextShareSkyDriveTemplate/for",fn:{fn:function(n,t,i,r){var i=i||jsviews,e,f=i._cnvt,o=i.converters.html,u="";return u+="        <div ",u+=(e=t.hlp("sutra")("skydrivedocumentitem"))!=r?e:"",u+=' class="shareSkyDriveItem" style="padding-bottom:10px" objectId="',u+=f("attr",t,{params:"id",props:{},args:[n.id]}),u+='" viewLink="',u+=f("attr",t,{params:"viewInBrowserLink",props:{},args:[n.viewInBrowserLink]}),u+='" ext="',u+=f("attr",t,{params:"extension",props:{},args:[n.extension]}),u+='">            <img ',u+=(e=t.hlp("sutra")("skydrivethumbnail"))!=r?e:"",u+=' src="',u+=f("attr",t,{params:"typeImage",props:{},args:[n.typeImage]}),u+='" onerror="this.src=\'',u+=f("attr",t,{params:"defaultImage",props:{},args:[n.defaultImage]}),u+='\'" style="display:inline-block;cursor:pointer;margin-bottom:-3px;" />                <a ',u+=(e=t.hlp("sutra")("skydrivelink"))!=r?e:"",u+=' href="',u+=f("attr",t,{params:"permissionsLink",props:{},args:[n.permissionsLink]}),u+='" style="',u+=f("attr",t,{params:"~getDocCss()",props:{},args:[t.hlp("getDocCss")()]}),u+='" data-link="href{:permissionsLink}">                    ',u+=o(n.name),u+=o(n.extension),u+"                <\/a>            <\/div>        "}}}],links:{},tags:{},bnds:[{fn:function(n){return[{tmpl:1,params:"images",props:{},args:[n.images]}]},paths:["images"],_ctxs:"for"},{fn:function(n){return[{tmpl:2,params:"docs",props:{},args:[n.docs]}]},paths:["docs"],_ctxs:"for"}],_is:"template",allowCode:!0,tmplName:"richTextShareSkyDriveTemplate",htmlTag:"div",fn:{fn:function(n,t,i,r){var i=i||jsviews,f,e=i._tag,u="";return u+="    <div ",u+=(f=t.hlp("sutra")("skydriveimagesection"))!=r?f:"",u+=' class="shareSkyDriveImages" style="padding-bottom:10px;">        ',u+=e("for",t,this,1),u+="    <\/div>    <div ",u+=(f=t.hlp("sutra")("skydrivedocumentsection"))!=r?f:"",u+=' class="shareSkyDriveDocs" style="clear:both;">        ',u+=e("for",t,this,2),u+"    <\/div>"}}}})(),function(n){"use strict";function u(){return{preMessageBody:"",postMessageBody:"",totalFileCount:0,shareSkyDriveData:{images:[],docs:[]}}}var f="POST",e=!1,o="#",s="cropped104",h=1102,c=2018,i=window.ol=window.ol||{},l=i.vm=i.vm||{},r=i.config.compose.shareSkyDrive,a=l.ShareSkyDrive=function(n){this.initAccessorValues(n)},t=a.prototype;i.AddOptionsAccessorAndInitFunctions(t,u),t.empty=function(){var i=this,t=u(),n;for(n in t)i[n](t[n])},t.addFile=function(t,u){var f=this,c,h,e,y;f.totalFileCount(f.totalFileCount()+1);var l=f._isImage(t)?f.ShareSkyDriveData.images:f.ShareSkyDriveData.docs,a=u?" "+i.GetString("ShareSkyDrive.Folder"):t.extension||"",v="";if(f._isImage(t))for(c=t.thumbnailSet,h=c.thumbnails,e=0;e<h.length;e++)if(h[e].name===s){v=c.baseUrl+h[e].url;break}y={typeImage:r.fileIconSrcUrlFormat.format(a.substring(1)),defaultImage:r.fileIconSrcUrlFormat.format("default"),extension:a,permissionsLink:o,thumbnailUrl:v,viewInBrowserLink:t.urls.viewInBrowser},n.extend(t,y),n.observable(l).insert(l.length,t)},t.removeItem=function(t){var i=this,r=i._isImage(t)?i.ShareSkyDriveData.images:i.ShareSkyDriveData.docs,u=r.indexOf(t);u>=0&&n.observable(r).remove(u,1),i.totalFileCount(i.totalFileCount()-1)},t.findItemWithObjectId=function(n){var i=this,t=null;return i._forEachImageAndDoc(function(i){i.id===n&&(t=i)}),t},t.viewInBrowser=function(n){$BSI.navigateTo(n.viewInBrowserLink,"_blank")},t.generateLinks=function(){var t=n.Deferred(),i=[],r=this;return r._forEachImageAndDoc(function(n){i.push(n.id)}),r._skyApiGetLink(i,t,e),t.promise()},t.getDataPoints=function(){var n=this,t={count:n.totalFileCount()||0};return n._forEachImageAndDoc(function(n){var t=n.extension||"none";$BSI.reportEvent("Cmp.SDLink",{FileExtension:t[0]==="."?n.extension.substring(1):t})}),t},t._forEachImageAndDoc=function(n){var t=this,i,r;if(t.ShareSkyDriveData){for(i=t.ShareSkyDriveData.images.length-1;i>=0;i--)n(t.ShareSkyDriveData.images[i],i,t.ShareSkyDriveData.images);for(r=t.ShareSkyDriveData.docs.length-1;r>=0;r--)n(t.ShareSkyDriveData.docs[r],r,t.ShareSkyDriveData.docs)}},t.rehydrateExistingSkyDriveItems=function(t){var e=t.find(".shareSkyDriveTable"),i=this,h,c,o,u,f;if(e.length){for(h=i.postMessageBody(),i.empty(),i.preMessageBody(e.find("#ecx_rte_preskyattach").html()),h?i.postMessageBody(h):i.postMessageBody(e.find("#ecx_rte_postskyattach").html()),c=e.find(".shareSkyDriveItem"),o=0;o<c.length;o++){var r=n(c[o]),l=r.find("a"),s=r.find("img");l&&s&&(u={permissionsLink:l.attr("href"),id:r.attr("objectId"),viewInBrowserLink:r.attr("viewLink"),extension:r.attr("ext")},f={},r.is("span")?(u=n.extend(u,{urls:{open:s.attr("src")},photo:{},thumbnailUrl:s.attr("src")}),f=i.ShareSkyDriveData.images):(u=n.extend(u,{typeImage:s.attr("src"),name:l.text().trim(),extension:"",defaultImage:""}),f=i.ShareSkyDriveData.docs),n.observable(f).insert(f.length,u))}return i.totalFileCount(i.ShareSkyDriveData.images.length+i.ShareSkyDriveData.docs.length),!0}return!1},t._isImage=function(n){return!!n.photo},t._skyApiGetLink=function(t,u,e){function y(r){var l=n.parseJSON(r.responseText),a,e,o,f;if(l)if(l.error){switch(l.error.code){case c:a=i.GetString("SkyApi.Permissions.ItemContainsCoOwnedItem");break;case h:a=i.GetString("SkyApi.Permissions.OnlyUserOwnedItemsAllowedOnBundlesError")}u.reject(a)}else{for(e=l.permissions.permissionScopes[0].entities,f=0;f<e.length;f++)if(e[f].linkType&&e[f].linkType===s){o=e[f].link,t.length!==1&&(o=o.replace(new RegExp("&resid=","gi"),"&parentid="));break}v._forEachImageAndDoc(function(n){var r=o;t.length!==1&&(r="{0}&resid={1}".format(o,n.id)),i.Accessor(n,"permissionsLink",r)}),u.resolve()}else u.reject()}var v=this,s,o,l,a;if(!t.length){u.resolve();return}s=2,o={entities:[{role:e?2:1,linkType:s,type:3}],requireSignIn:!1},t.length===1?o.id=t[0]:o.ids=t,l=i.compose.composeVm.InitContext.shareSkyDrive,a={Accept:"application/json",AppId:r.skyDriveAppId.toString(),canary:l.skyApiCanary},$Network.fetchXML(r.skyDriveBaseUrl+r.skyApiCall,y,f,JSON.stringify(o),a),setTimeout(function(){u.reject()},r.skyApiTimeout)}}(window.originaljQuery||window.jQuery),function(n,t){"use strict";var e="user_canceled",o="request_canceled",i="#ecx_rte_preskyattach",r="#ecx_rte_postskyattach",u=wLive.Controls.Notifications,c=n.BrowserCapabilities,f=n.config.Ltr?"right":"left",s=t.templates(null,{markup:"#initialShareSkyDriveTemplate",converters:{getHeader:function(t){var i=t>1?n.GetString("ShareSkyDrive.TemplateHeaderPlural"):n.GetString("ShareSkyDrive.TemplateHeaderSingular"),r=n.compose.composeVm.InitContext.shareSkyDrive;return i.format(r.userShortName)}}}),h={template:"<div><\/div>",attr:"html",init:function(i){var r=this;r.data=i.ctx.data,r.thread=i.ctx.thread,r.ControlNamespace=n.createControlNamespace(r.tagName),t.observable.simpleOn(r.data,"propertyChange."+r.ControlNamespace,t.proxy(r._onPropertyChange,r)),t.observable.simpleOn(r.thread,"propertyChange."+r.ControlNamespace,t.proxy(r._textModeChange,r))},render:function(){return this.tagCtx.render(this.data)},onAfterLink:function(){},onDispose:function(){var n=this;t.observable.simpleOff(n.data,"propertyChange."+n.ControlNamespace),t.observable.simpleOff(n.thread,"propertyChange."+n.ControlNamespace)},onRehydrate:function(){var n=this;n._linkInitialized||(n._createLink(),n._linkInitialized=!0)},_createLink:function(){var u=this,e;u._inlineElem=document.createElement("div"),e=t(u._inlineElem),e.link(s,u.data,t.extend({getImageCss:function(){return"padding-bottom:5px;border:none;padding-{0}:5px;".format(f)},getDocCss:function(){return"font-size:10pt;color:#0068CF; text-decoration:none;padding-{0}:20px;".format(f)},getHeaderCss:function(){return"padding-bottom:10px;color:#666;font-size:14px;"}},n.getContextObject())),e.find(i).html(u.data.preMessageBody()),e.find(r).html(u.data.postMessageBody()),n.Cmd("rte.setbody").bubble(this,{value:this._inlineElem}),this._updateContentEditable(!1),n.Cmd("rte.selectionchange").bubble(u)},_updateContentEditable:function(t){n.Cmd("rte.contenteditable").bubble(this,{value:t})},_textModeChange:function(t,i){i.path==="TextMode"&&(this._updatePreAndPostMessageBody(),this.thread.TextMode!==n.vm.Compose.TextModes.RichText?this._removeLink():this.data.TotalFileCount>0&&this._createLink())},_updatePreAndPostMessageBody:function(){this.data.preMessageBody(t(this._inlineElem).find(i).html()),this.data.postMessageBody(t(this._inlineElem).find(r).html())},openPicker:function(){n.Cmd("keyboardhandler.enable").fire({value:!1});var i=n.config.compose.shareSkyDrive,r=window.WL;r.init({client_id:i.skyDriveAppId.toString(),env:i.skyDriveAppEnv}),this._skyPicker=r.fileDialog({mode:"open",lightbox:"grey",select:"multi"}).then(t.proxy(this._handleSkyPickerSuccess,this),t.proxy(this._handleSkyPickerError,this))},closeSkyPicker:function(){this._skyPicker&&(this._skyPicker.cancel(),this._skyPicker=null)},loseControl:function(){this.closeSkyPicker()},_removeLink:function(){if(this._linkInitialized){this._linkInitialized=!1,this._updatePreAndPostMessageBody(),t(this._inlineElem).remove(),this._updateContentEditable(!0);var i=(this.data.preMessageBody()||"")+"<br>"+(this.data.postMessageBody()||"");i==="<br>"&&(i=""),n.Cmd("rte.setbody").bubble(this,{value:i})}},_onPropertyChange:function(n,t){t.path==="TotalFileCount"&&t.value===0&&this._removeLink()},generateLinks:function(){var t=this;return this.data.generateLinks().fail(function(i){t._showError(i||n.GetString("ShareSkyDrive.SkyAPIError"))})},_handleSkyPickerSuccess:function(i){var r=this,u,f,e;if(r._linkInitialized||(r._createLink(),r._linkInitialized=!0),u=[],i.data.files)for(t.merge(u,i.data.files),f=0;f<i.data.files.length;f++)r.data.addFile(i.data.files[f]);if(i.data.folders)for(t.merge(u,i.data.folders),e=0;e<i.data.folders.length;e++)r.data.addFile(i.data.folders[e],!0);n.Cmd("instrument.insertfromskydrive").fire({files:u,numSelected:u.length,entryPoint:HM.InstrumentationEntryPoint.Other,isFullCompose:r.thread.isFullCompose()}),n.Cmd("keyboardhandler.enable").fire({value:!0}),n.Cmd("rte.selectionchange").bubble(r)},_handleSkyPickerError:function(t){t.error&&t.error.code!==e&&error.code!==o&&this._showError(n.GetString("ShareSkyDrive.SkyPickerError")),n.Cmd("keyboardhandler.enable").fire({value:!0})},_showError:function(t){u.createTopBar({content:t||n.GetString("ShareSkyDrive.SkyPickerError"),dismissalMode:u.BarDismissalMode.Timeout}).show()},onContextMenuAction:function(n){var t=this,i=n.target,r=i.view().data||t.data.findItemWithObjectId(i.attr("objectId"));switch(n.key){case"ShareSkyDriveView":t.data.viewInBrowser(r);break;case"ShareSkyDriveRemove":t.data.removeItem(r)}}};t.views.tags({shareSkyDriveControl:h}),n.markControlAsLoaded("shareSkyDriveControl")}(window.ol,window.originaljQuery||window.jQuery)